---
title: "A guide to model input and output data"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{A guide to model input and output data}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Input data

The model requires a data table containing the following columns:

| name         | type            | description                                                                                       |
|--------------|-----------------|---------------------------------------------------------------------------------------------------|
| pid          | numeric         | Unique number to identify a person across observations                                            |
| day          | integer or date | The day of the observation. Can be a date or an integer representing a relative day of study      |
| last_exp_day | integer or date | The most recent day on which the person was exposed. Must be of the same type as the 'day' column |
| titre_type   | character       | Name of the titre or biomarker                                                                    |
| value        | numeric         | Titre value                                                                                       |
| censored     | -1, 0 or 1      | Whether this observation should be treated as censored: -1 for lower, 1 for upper, 0 for none     |

It can also contain further columns for any covariates to be included in the model. The data files installed with this package have additional columns infection_history, last_vax_type, and exp_num.

The model also accepts a covariate formula to define the regression model. The variables in the formula must correspond to column names in the dataset. Note that all variables will be treated as **categorical variables**; that is, converted to factors regardless of their input type.

## Example

```{r}
dat <- data.table::fread(system.file("delta_full.rds", package = "epikinetics"))
head(dat)
```

# Ouput data

After fitting a model, a [CmdStanMCMC](https://mc-stan.org/cmdstanr/reference/CmdStanMCMC.html) object is returned. This means
that users who are already familiar with `cmdstanr` are free to do what they want with the fitted model.

**Important!**
**The data provided to `biokinetics$new` is converted to a base2 log scale before inference is performed. This means that if working
directly with the fitted `CmdStanMCMC` all values will be on this scale. The package provides a helper function for converting
back to the original scale: [convert_log_scale_inverse](../reference/convert_log_scale_inverse.html).**

Three further functions provide model outputs that we think are particularly useful in [data.table](https://cran.r-project.org/web/packages/data.table/) format.
[biokinetics](../reference/biokinetics.html) contains documentation on each of these functions so please read that first; this Vignette provides
guidance on the correct interpretation of each column in the returned tables. (In these functions data is returned on the original scale).

## simulate_population_trajectories

See the documentation for this function [here](../reference/biokinetics.html#method-simulate-population-trajectories).
There are 2 different output formats depending on whether the provided `summarise` argument is `TRUE` or `FALSE`.

* `summarise = TRUE`
    Returned columns are

    | name                | type       | description                                                                                   |
    |---------------------|------------|-----------------------------------------------------------------------------------------------|
    | time_since_last_exp | integer    | Number of days since last exposure                                                            |
    | me                  | numeric    | Median titre value                                                                            |
    | lo                  | numeric    | Titre value at the 0.025 quantile                                                             |
    | hi                  | numeric    | Titre value at the 0.975 quantile                                                             |
    | titre_type          | character  | Name of the titre or biomarker                                                                |
    | censored            | -1, 0 or 1 | Whether this observation should be treated as censored: -1 for lower, 1 for upper, 0 for none |

There will also be a column for each covariate in the regression model.

* `summarise = FALSE`
    Returned columns are

    | name                | type    | description                        |
    |---------------------|---------|------------------------------------|
    | time_since_last_exp | integer | Number of days since last exposure |
    | t0_pop              | numeric |                                    |
    | tp_pop              | numeric |                                    |
    | ts_pop              | numeric |                                    |
    | m1_pop              | numeric |                                    |
    | m2_pop              | numeric |                                    |
    | m3_pop              | numeric |                                    |
    | beta_t0             | numeric |                                    |
    | beta_tp             | numeric |                                    |
    | beta_ts             | numeric |                                    |
    | beta_m1             | numeric |                                    |
    | beta_m2             | numeric |                                    |
    | beta_t3             | numeric |                                    |
    | mu                  | numeric | Titre value                        |
    | .draw               | integer | Draw number                        |
    | titre_type          | numeric | Name of the titre or biomarker     |

There will also be column for each covariate in the hierarchical model.
