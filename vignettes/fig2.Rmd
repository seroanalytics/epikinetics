---
title: "SARS-CoV-2 antibody model: replicating paper figures"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{delta}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Fitting the model

First run the model for each wave separately, using the data files installed with this package.
Here we run it just for the Delta wave:

```{r}
dat <- data.table::fread(system.file("delta_full.rds", package = "epikinetics"))
mod <- epikinetics::sam$new(data = dat)

# using a small number of chains and iterations for speed; for accurate results keep these arguments at their defaults
delta <- mod$fit(chains = 4,
                 parallel_chains = 4,
                 iter_warmup = 10,
                 iter_sampling = 40,
                 threads_per_chain = 4)
```

# Figure 2
Figure 2 from the paper shows population level fits for each wave, disaggregated by infection history
and titre type. This is a partial reconstruction of that figure to demonstrate how to use the package.

Once the model has been fitted, process the fits into trajectories:

```{r}
res <- mod$population_trajectories()
head(res)
```

And now plot using `ggplot`:

```{r}
library(ggplot2)
manual_pal <-
  c("#CC6677",
    "#DDCC77",
    "#88CCEE",
    "#882255",
    "#44AA99",
    "grey",
    "#D95F02",
    "#66A61E")
res$titre_type <- forcats::fct_relevel(res$titre_type, c("Ancestral", "Alpha", "Delta"))
ggplot() +
  geom_line(data = res,
            aes(x = t,
                y = me,
                colour = titre_type,
                linetype = "Retrospective")) +
  geom_ribbon(data = res,
              aes(x = t,
                  ymin = lo,
                  ymax = hi,
                  fill = titre_type), alpha = 0.65) +
  scale_y_continuous(
    trans = "log2",
    breaks = c(40, 80, 160, 320, 640, 1280,
               2560, 5120),
    labels = c("40", "80", "160", "320", "640", "1280", "2560", "5120"),
    limits = c(40, 10240)) +
  scale_x_continuous(breaks = c(0, 30, 60, 90, 120),
                     labels = c("0", "30", "60", "90", "120"),
                     expand = c(0, 0)) +
  coord_cartesian(clip = "off") +
  labs(x = "Time since last exposure (days)",
       y = expression(paste("Titre (IC"[50], ")"))) +
  facet_wrap(infection_history ~ titre_type) +
  theme(
    legend.position = "bottom",
    strip.text.x.top = element_text(size = 8, family = "Helvetica"),
    strip.text.x = element_text(size = 8, family = "Helvetica")) +
  scale_colour_manual(values = manual_pal) +
  scale_fill_manual(values = manual_pal) +
  theme_linedraw() +
  theme(legend.position = "bottom",
        text = element_text(size = 8, family = "Helvetica"),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(colour = 'black'),
        strip.placement = "outside",
        plot.title = element_text(face = "bold", size = 9),
        panel.grid = element_line(linewidth = 0.4)) +
  guides(colour = "none", fill = "none")
```

# Figure 4

Figure 4 A and B show the relationship between infection history and titre values at peak and set points, for different
titre types. For Figure 4.A, in the paper there are facets for each wave, but here we just generate the facet for the Delta wave.

[//]: # (```{r})

[//]: # (res <- mod$population_stationary_ponts&#40;&#41;)

[//]: # (head&#40;res&#41;)

[//]: # (```)

[//]: # ()
[//]: # (```{r})

[//]: # (ggplot&#40;data = res, aes&#40;)

[//]: # (  x = mu_p, y = mu_s,)

[//]: # (  colour = titre_type&#41;&#41; +)

[//]: # (  geom_density_2d&#40;)

[//]: # (    aes&#40;)

[//]: # (      group = interaction&#40;)

[//]: # (        infection_history,)

[//]: # (        titre_type&#41;&#41;&#41; +)

[//]: # (  geom_point&#40;data = res[.draw <= 2000],)

[//]: # (             alpha = 0.05, size = 0.2&#41; +)

[//]: # (  geom_point&#40;data = res,)

[//]: # (             aes&#40;x = mu_p_me, y = mu_s_me,)

[//]: # (                 shape = infection_history&#41;,)

[//]: # (             colour = "black"&#41; +)

[//]: # (  geom_path&#40;data = res,)

[//]: # (            aes&#40;x = mu_p_me, y = mu_s_me,)

[//]: # (                group = titre_type&#41;,)

[//]: # (            colour = "black"&#41; +)

[//]: # (  geom_vline&#40;xintercept = 2560, linetype = "twodash", colour = "gray30"&#41; +)

[//]: # (  scale_x_continuous&#40;)

[//]: # (    trans = "log2",)

[//]: # (    breaks = c&#40;40, 80, 160, 320, 640, 1280, 2560, 5120, 10240&#41;,)

[//]: # (    labels = c&#40;expression&#40;" " <= 40&#41;,)

[//]: # (               "80", "160", "320", "640", "1280", "2560", "5120", "10240"&#41;,)

[//]: # (    limits = c&#40;NA, 10240&#41;&#41; +)

[//]: # (  geom_hline&#40;yintercept = 2560, linetype = "twodash", colour = "gray30"&#41; +)

[//]: # (  scale_y_continuous&#40;)

[//]: # (    trans = "log2",)

[//]: # (    breaks = c&#40;40, 80, 160, 320, 640, 1280, 2560, 5120, 10240&#41;,)

[//]: # (    labels = c&#40;expression&#40;" " <= 40&#41;,)

[//]: # (               "80", "160", "320", "640", "1280", "2560", "5120", "10240"&#41;,)

[//]: # (    limits = c&#40;NA, 5120&#41;&#41; +)

[//]: # (  theme_linedraw&#40;&#41; +)

[//]: # (  theme&#40;legend.position = "bottom",)

[//]: # (        text = element_text&#40;size = 9, family = "Helvetica"&#41;,)

[//]: # (        strip.placement = "outside",)

[//]: # (        plot.title = element_text&#40;face = "plain", size = 9&#41;,)

[//]: # (        legend.box = "vertical",)

[//]: # (        legend.margin = margin&#40;&#41;,)

[//]: # (        strip.background = element_rect&#40;fill = "white"&#41;,)

[//]: # (        strip.text = element_text&#40;colour = 'black'&#41;&#41; +)

[//]: # (  scale_shape_manual&#40;values = c&#40;1, 2, 3&#41;&#41; +)

[//]: # (  labs&#40;x = expression&#40;paste&#40;"Population-level titre value at peak &#40;IC"[50], "&#41;"&#41;&#41;,)

[//]: # (       y = expression&#40;paste&#40;"Population-level titre value at set-point &#40;IC"[50], "&#41;"&#41;&#41;&#41; +)

[//]: # (  scale_colour_manual&#40;values = manual_pal&#41; +)

[//]: # (  guides&#40;colour = guide_legend&#40;override.aes = list&#40;alpha = 1, size = 1&#41;&#41;&#41;)

[//]: # (```)
